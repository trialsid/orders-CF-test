Project: Order.Ieeja grocery storefront (Cloudflare Pages + D1).
Stack: React (Vite) with Tailwind design system (green accents, light/dark theme), lucide-react icons, TypeScript hooks/components, Cloudflare Pages Functions backend, Cloudflare D1 database for orders.

- src/: React app with MainLayout providing theme/locale context and checkout draft persistence, routed pages (Home, Browse, Product detail, Cart, Checkout, Checkout success, Orders, Support, Admin, Rider, Account), reusable components (SiteNav, ProductsSection, CartSection, Toast, MobileStickyAction), hooks (useProducts, useCart, useOrders, useAdminConfig, useAccount), utilities (formatCurrency, checkout helpers, updateOrderStatus).
- functions/: Cloudflare Pages Functions modules (products.js inventory endpoint, order.js order submission/listing/status updates backed by D1, config.js for delivery economics admin API, auth/register|login|me route handlers backed by shared _auth.js helpers, account/index|profile|addresses for profile + saved addresses APIs).
- src/context/AuthContext.tsx persists JWTs in localStorage, refreshes sessions via /auth/me, and exposes login/register/logout hooks; src/pages/AuthPage.tsx renders the shared UI for /auth/login + /auth/register with translations + Tailwind cards.
- migrations/: Versioned D1 schema migrations (0001_create_orders.sql, 0002_add_order_details.sql, 0003_create_admin_config.sql, 0004_create_users.sql, 0005_enrich_users_and_orders.sql) applied locally; remote application pending.
- wrangler.toml: name="order-ieeja", compatibility_date="2025-07-18", pages_build_output_dir="dist", D1 binding ORDERS_DB -> database_id 0eaea965-4467-4aee-89a9-28aed83e4c79.

- POST /order validates cart payload, requires phone/address/slot/payment, persists to D1 (orders table with customer, delivery, payment fields), and when a bearer token is present records orders.user_id plus a saved address entry (user_addresses + orders.delivery_address_id) while still snapshotting customer data.
- GET /order lists recent orders (limit query param), includes structured customer/delivery/payment data used by Orders page; admins/riders get the full feed, while customer JWTs only see their own orders.
- PATCH /order allows staff/riders to move orders across statuses (pending→confirmed→outForDelivery→delivered/cancelled) via the admin/rider consoles and enforces the same role-based bearer tokens.
- GET/PUT /config exposes delivery economics (minimum order, free delivery threshold, below-threshold fee) stored in D1 admin_config and is restricted to admin tokens.
- New /auth endpoints (register/login/me) persist PBKDF2-hashed credentials in D1 users table and sign JWTs with AUTH_SECRET for downstream role-based access (MSG91 OTP wiring TBD).
- User profiles now include full_name + primary_address_json, and the new user_addresses table indexes every saved delivery address (default flagged) so Orders can reference users.user_id + orders.delivery_address_id while still keeping immutable snapshots.

- Mobile sticky CTAs use two-tier lime/amber info chips with dual-action pills and now hide automatically when the keyboard opens.
- Browse page (formerly Discover) pulls departments from the live catalog, renders horizontal department chips, and shows compact product cards with category chips plus inline quantity controls on both mobile and desktop; desktop hero CTA and product detail page convert to “− qty +” controls once an item is added.
- Cart and checkout keep the refreshed quantity styling, persist draft data, and redirect to a dedicated success screen after submission; success + Orders pages surface live customer/delivery/payment details.
- Hero + features copy now pitch “Ieeja supermarket delivery” with ₹100 minimum order, free delivery above ₹299, and ₹15 fee otherwise; metrics and store note reinforce the same pricing in both locales.
- Admin page offers an ops dashboard (metrics, live fulfilment queue, recent submissions, delivery economics form synced via useAdminConfig) with mobile-friendly cards and branded scrollbars; Rider page presents a pared-down queue for confirmed/out-for-delivery jobs with tap-to-call, address, and status advance controls. Both screens now surface the signed-in operator badge and use auth tokens when mutating data. The Account page lets customers edit profile names and manage saved delivery addresses (create/edit/delete, default).
- SiteNav pulls from AuthContext – logged-in users see quick links to their console plus a logout control, while logged-out visitors get a Sign in CTA (mobile + desktop). Admin/Rider routes are gated via a RequireAuth wrapper that redirects to /auth/login when needed.
- Scroll UI (global + horizontal scrollers) now uses emerald-themed custom scrollbars to match the design system.
- Local catalog source: proposed-280-SKUs.csv (kept outside deployment) feeds scripts/generate-inventory.mjs → functions/_inventory-data.json; npm run build:inventory runs automatically before dev/build.
- Development: npm run dev (Vite) + npm run cf:dev (Wrangler dev). D1 migrations applied locally (0001-0004); hold remote migration/app binding until deploy.
- Dev servers (vite or wrangler pages) may cache index.html; restart or disable cache in DevTools if hashed bundles 404.
- npm run build currently fails in this environment due to missing optional dependency `@rollup/rollup-linux-x64-gnu`; reinstall dependencies if a local build is needed.
- Pending work ideas: richer Orders UI with customer-facing status tracking, secure auth/roles for /admin + /rider, assign-per-rider queues with push updates, storing slot/payment config in D1, and PWA/service worker manifest when ready.
- Auth/DB notes (Nov 21, 2025): Cloudflare SubtleCrypto PBKDF2 caps at 100k iterations; functions/_auth.js uses PBKDF2_ITERATIONS=100000 to avoid 500s on register. Production domain order.ieeja.com uses Pages project name order-ieeja; ensure AUTH_SECRET is set in Preview/Production and D1 binding ORDERS_DB is attached. README updated to reflect order-ieeja and cf:dev/deploy scripts. Remote DB snapshot can be pulled via `npx wrangler@latest d1 export order_ieeja_orders --remote --output backup.sql` and loaded locally (e.g., `npx wrangler@latest d1 execute order_ieeja_orders --local --file backup.sql`, optionally with `--persist-to`). Default local state lives under .wrangler/state; using that avoids needing `--persist-to` for cf:dev.
- DB sync scripts: package.json adds cf:db:export/reorder/import/sync/refresh/users/users:remote. `npm run cf:db:refresh` clears .wrangler/state, exports remote, reorders backup.sql (scripts/reorder-d1-export.js) to create users before orders and d1_migrations before sqlite_sequence, then imports into local D1. `npm run cf:dev` can run without --persist-to when using .wrangler/state. `npm run cf:db:users` (local) and `npm run cf:db:users:remote` list phone/role/status.

Note: Keep dist/ out of git; Pages binding ORDERS_DB must be added in Cloudflare dashboard before deploy. Context last updated Nov 29, 2025 after CSV-driven inventory ingestion, Browse page rebrand/department filters, desktop quantity controls, product detail CTA parity, and updated hero/delivery messaging for ₹100 minimum / ₹299 free delivery / ₹15 fee below threshold.
